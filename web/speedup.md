# [ç½‘é¡µæ€§èƒ½ç®¡ç†è¯¦è§£](http://www.ruanyifeng.com/blog/2015/09/web-page-performance-in-depth.html)
åº”è¯¥æœç»å“åº”ç¼“æ…¢ï¼Œå ç”¨å¤§é‡èµ„æºçš„ç½‘é¡µ  

## ç½‘é¡µç”Ÿæˆçš„è¿‡ç¨‹ï¼š  
1. HTMLä»£ç è½¬åŒ–æˆDOM(Document Object Model)
2. CSSä»£ç è½¬æ¢æˆCSSOMï¼ˆCSS OBJECT MODELï¼‰  
3. ç»“åˆDOMå’ŒCSSOMï¼Œç”Ÿæˆä¸€æ£µæ¸²æŸ“æ ‘ï¼ˆåŒ…å«æ¯ä¸ªèŠ‚ç‚¹çš„è§†è§‰ä¿¡æ¯ï¼‰  
4. ç”Ÿæˆå¸ƒå±€ï¼ˆlayoutï¼‰ï¼Œå³å°†æ‰€æœ‰æ¸²æŸ“æ ‘çš„æ‰€æœ‰èŠ‚ç‚¹è¿›è¡Œå¹³é¢åˆæˆ  
5. å°†å¸ƒå±€ç»˜åˆ¶ï¼ˆpaintï¼‰åœ¨å±å¹•ä¸Š  
> è¿™äº”æ­¥é‡Œï¼Œä¸€åˆ°ä¸‰éƒ½æ˜¯éžå¸¸å¿«çš„ï¼Œè€—æ—¶çš„æ˜¯ç¬¬å››æ­¥å’Œç¬¬äº”æ­¥  
> ç”Ÿæˆå¸ƒå±€(flow)å’Œç»˜åˆ¶(paint)è¿™ä¸¤éƒ¨ï¼Œåˆæˆä¸º"æ¸²æŸ“"(render)(æˆ‘è¿˜ä»¥ä¸ºæ•´ä¸ªè¿‡ç¨‹æ˜¯æ¸²æŸ“ðŸ˜”)  

## é‡æŽ’å’Œé‡ç»˜
ç”Ÿæˆç½‘é¡µçš„æ—¶å€™ï¼Œè‡³å°‘ä¼šæ¸²æŸ“ä¸€æ¬¡ï¼Œè®¿é—®è¿‡ç¨‹ä¸­ï¼Œè¿˜ä¼šä¸æ–­æ¸²æŸ“  
ç½‘é¡µé‡æ–°æ¸²æŸ“çš„å‡ ç§æƒ…å†µï¼š  
1. ä¿®æ”¹DOM  
2. ä¿®æ”¹æ ·å¼è¡¨  
3. ç”¨æˆ·äº‹ä»¶ï¼ˆé¼ æ ‡æ‚¬åœï¼Œé¡µé¢æ»šåŠ¨ï¼Œè¾“å…¥æ¡†é”®å…¥æ–‡å­—ï¼Œæ”¹å˜çª—å£å¤§å°ç­‰ï¼‰  
é‡æ–°æ¸²æŸ“ï¼Œå°±éœ€è¦é‡æŽ’(reflow)-é‡æ–°ç”Ÿæˆæ–°çš„å¸ƒå±€ï¼Œé‡ç»˜ï¼ˆrepaintï¼‰  
æ³¨æ„ï¼šé‡ç»˜ä¸ä¸€å®šä¼šå‡ºå‘é‡æŽ’ï¼Œå¦‚æ”¹å˜å…ƒç´ çš„é¢œè‰²

## å¯¹äºŽæ€§èƒ½çš„å½±å“
é‡æŽ’å’Œé‡ç»˜æ˜¯å½±å“æ€§èƒ½çš„æ ¹æœ¬åŽŸå›   
```js
div.style.color = 'blue'
div.style.marginTop = '30px'
```
æµè§ˆå™¨å·²è¶³å¤Ÿæ™ºèƒ½ï¼Œä¼šå°½é‡æŠŠæ‰€æœ‰çš„å˜åŠ¨é›†ä¸­èµ·æ¥ï¼ŒæŽ’æˆé˜Ÿåˆ—ï¼Œä¸€æ¬¡æ‰§è¡Œï¼Œä¸Šè¿°æƒ…å†µåªä¼šè§¦å‘ä¸€æ¬¡é‡æŽ’å’Œé‡ç»˜
```js
div.style.color = 'blue'
var margin = parseInt(div.style.marginTop)
div.style.marginTop = (margin + 10) + 'px'
```
ä»¥ä¸Šä»£ç å°±å±žäºŽçƒ‚ä»£ç ï¼Œä¼šè¿«ä½¿æµè§ˆå™¨å…ˆé‡ç»˜ï¼Œå†é‡æŽ’  
ä¸€èˆ¬æ¥è¯´ï¼Œæ ·å¼çš„å†™æ“ä½œä¹‹åŽï¼Œå¦‚æœ‰ä¸‹é¢çš„è¿™äº›è¯»æ“ä½œï¼Œéƒ½ä¼šè®©æµè§ˆå™¨é‡æ–°æ¸²æŸ“  
- offsetTop / offsetLeft / offsetWidth / offsetHeight  
- scrollTop / scrollLeft / scrollWidth / scrollHeight  
- clientTop / clientLeft / clientWidth / clientHeight  
- getComputedStye()  
> å°½é‡ä¸è¦æŠŠè¯»æ“ä½œå’Œå†™æ“ä½œæ”¾åœ¨ä¸€ä¸ªè¯­å¥é‡Œï¼ˆå…ˆè¯»å†å†™ï¼Ÿï¼‰
```js
// bad
div.style.left = div.offsetLeft + 10 + "px"
div.style.top = div.offsetTop + 10 + "px"

// good
var left = div.offsetLeft
var top = div.offsetTop
div.style.left = left + 10 + "px"
div.style.top = top + 10 + "px"
```
> æ ·å¼è¡¨è¶Šç®€å•ï¼Œé‡æŽ’å’Œé‡ç»˜å°±è¶Šå¿«
> DOMå…ƒç´ å±‚çº§è¶Šé«˜ï¼Œæˆæœ¬å°±è¶Šé«˜
> table å…ƒç´ çš„é‡æŽ’å’Œé‡ç»˜é™ˆæœ¬é«˜äºŽdiv(è¿™å°±æ˜¯divå¸ƒå±€æ¯”è¾ƒæµè¡Œçš„åŽŸå› ï¼Ÿ)

## æé«˜æ€§èƒ½çš„9ä¸ªæŠ€å·§
1. DOMå…ƒç´ çš„è¯»å†™æ“ä½œåº”è¯¥æ”¾åœ¨ä¸€èµ·ï¼Œä¸è¦ç©¿æ’  
2. å¦‚æžœæŸä¸ªæ ·å¼æ˜¯é€šè¿‡é‡æŽ’å¾—åˆ°çš„ï¼Œé‚£ä¹ˆæœ€å¥½ç¼“å­˜ä¸€ä¸‹ï¼Œé¿å…ä¸‹ä¸€æ¬¡ç”¨åˆ°æ—¶ï¼Œæµè§ˆå™¨åˆè¦é‡æŽ’  
3. é€šè¿‡æ”¹å˜`css`æˆ–è€…`csstext`å±žæ€§ä¸€æ¬¡æ€§çš„æ”¹å˜æ ·å¼
```js
// bad
var left = 10
var top = 10
el.style.left = left + "px"
el.style.top = top + "px"

// good
el.className += " theclassname"

// good
el.style.cssText += "; left: " + left + "px; top: " + top + "px;"
```
4. å°½é‡ä½¿ç”¨ç¦»çº¿DOMï¼Œè€Œä¸æ˜¯çœŸæ˜¯çš„ç½‘é¡µDOMï¼Œæ¥æ”¹å˜å…ƒç´ æ ·å¼ï¼š  
å¦‚ï¼šæ“ä½œDocument Fragmentå¯¹è±¡ï¼Œå®ŒæˆåŽæŠŠè¿™ä¸ªå¯¹è±¡åŠ å…¥DOM  
å†æ¯”å¦‚ï¼šä½¿ç”¨`cloneNode()`æ–¹æ³•ï¼Œåœ¨å…‹éš†çš„èŠ‚ç‚¹ä¸Šè¿›è¡Œæ“ä½œï¼Œç„¶åŽå†ç”¨å…‹éš†çš„èŠ‚ç‚¹ä»£æ›¿åŽŸå§‹èŠ‚ç‚¹  
5. å…ˆå°†å…ƒç´ è®¾ä¸º`display:
   none`(éœ€è¦ä¸€æ¬¡é‡æŽ’é‡ç»˜)ï¼Œç„¶åŽå¯¹è¿™ä¸ªèŠ‚ç‚¹è¿›è¡Œ100æ¬¡æ“ä½œï¼Œå†æ¢å¤æ˜¾ç¤º(ä¸€æ¬¡é‡æŽ’é‡ç»˜)ï¼Œç»“æžœå°±æ˜¯2æ¬¡æŠµä¸€æ¬¡  
6. positionå±žæ€§ä¸º`absolute`æˆ–`fixed`çš„å…ƒç´ ï¼Œé‡æŽ’çš„å¼€é”€ä¼šæ¯”è¾ƒå°ï¼Œå› ä¸ºä¸ç”¨è€ƒè™‘å…¶ä»–å…ƒç´ çš„å½±å“  
7. åªåœ¨å¿…è¦æ—¶ï¼Œæ‰å°†å…ƒç´ çš„`display`å±žæ€§è®¾ä¸ºå¯è§ï¼Œ`visibility:
   hidden`çš„å…ƒç´ åªå½±å“é‡ç»˜  
8. ä½¿ç”¨è™šæ‹Ÿçš„DOMè„šæœ¬åº“ï¼Œå¦‚React(ä»€ä¹ˆå«è™šæ‹Ÿçš„DOMè„šæœ¬åº“?)
9. ä½¿ç”¨`window.requestAnimationFrame()`ã€`window.requestIdleCallback()`è¿™ä¸¤ä¸ªæ–¹æ³•è°ƒèŠ‚é‡æ–°æ¸²æŸ“

## åˆ·æ–°çŽ‡
24å¸§çš„é¢‘çŽ‡æ˜¾å¡é¡¿ï¼Œ30-60å¸§æ‰æ¯”è¾ƒæµç•…ï¼Œå¤§å¤šæ•°æ˜¾ç¤ºå™¨çš„åˆ·æ–°é¢‘çŽ‡æ˜¯60Hz  
ä¸ºäº†ä¸Žç³»ç»Ÿä¸€è‡´ï¼Œä»¥èŠ‚çœç”µåŠ›ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨æŒ‰ç…§è¿™ä¸ªé¢‘çŽ‡åˆ·æ–°åŠ¨ç”»  
å¦‚æžœç½‘é¡µåŠ¨ç”»èƒ½åšåˆ°æ¯ç§’60å¸§ï¼Œå°±ä¼šæ ¹æ˜¾ç¤ºå™¨åŒæ­¥åˆ·æ–°ï¼Œè¾¾åˆ°æœ€ä½³è§†è§‰æ•ˆæžœã€‚è¿™æ„å‘³ç€ä¸€ç§’ä¹‹å†…è¿›è¡Œ60æ­¤é‡æ–°æ¸²æŸ“ï¼Œæ¯æ¬¡é‡æ–°æ¸²æŸ“çš„æ—¶é—´ä¸è¶…è¿‡16.66ms  
ä¸€ç§’ä¹‹é—´èƒ½å¤Ÿå®Œæˆå¤šå°‘æ¬¡é‡æ–°æ¸²æŸ“ï¼Œè¿™ä¸ªæŒ‡æ ‡å°±è¢«æˆä¸º"åˆ·æ–°çŽ‡"(FPS Frame per second)ã€‚  
å¦‚æžœæƒ³è¾¾åˆ°60FPSï¼Œå°±æ„å‘³ç€JSçš„æ¯ä¸ªä»»åŠ¡çš„è€—æ—¶å¿…é¡»å°‘äºŽ16msã€‚ä¸€ä¸ªè§£å†³åŠžæ³•æ˜¯ä½¿ç”¨Web Workerï¼Œä¸»çº¿ç¨‹åªç”¨äºŽUIæ¸²æŸ“ï¼Œç„¶åŽè·ŸUIæ¸²æŸ“ä¸ç›¸å¹²çš„äººç‰©éƒ½æ”¾åœ¨Workerçº¿ç¨‹ã€‚

## Performance ï¼ˆå¤§æ¸…äº¡äº†ï¼‰
- è“è‰²ï¼šç½‘ç»œé€šä¿¡å’ŒHTMLè§£æž  
- é»„è‰²ï¼šJSæ‰§è¡Œ  
- ç´«è‰²ï¼šæ ·å¼è®¡ç®—å’Œå¸ƒå±€ï¼Œå³é‡æŽ’  
- ç»¿è‰²ï¼šé‡ç»˜  
å“ªç§è‰²å—æ¯”è¾ƒå¤šï¼Œè¯´æ˜Žæ€§èƒ½è€—è´¹åœ¨é‚£é‡Œï¼Œè‰²å—è¶Šé•¿ï¼Œé—®é¢˜è¶Šå¤§  

## window.requestAnimationFrame()
æœ‰ä¸€äº›JSæ–¹æ³•å¯ä»¥è°ƒèŠ‚é‡æ–°æ¸²æŸ“ï¼Œå¤§å¹…æé«˜ç½‘é¡µæ€§èƒ½ï¼Œå…¶ä¸­æœ€é‡è¦çš„å°±æ˜¯`window.requestAnimationFrame()`æ–¹æ³•ã€‚  
å®ƒå¯ä»¥å°†æŸäº›ä»£ç æ”¾åˆ°ä¸‹ä¸€æ¬¡é‡æ–°æ¸²æŸ“æ—¶æ‰§è¡Œ  
> é€å¸§æ‰§è¡Œï¼Œä¸€èˆ¬æ¥è¯´æ¯ç§’60æ¬¡ï¼Œ

```js
function doubleHeight(element) {
  var currentHeight = element.clientHeight;
  element.style.height = (currentHeight * 2) + 'px';
}
elements.firEach(doubleHeight);
```
> è¿™ä¸ªå¾ªçŽ¯åœ¨æ¯ä¸ªè¯»æ“ä½œåŽé¢éƒ½æŽ¥äº†ä¸€ä¸ªå†™æ“ä½œï¼Œè¿™æ ·ä¼šè§¦å‘å¤§é‡çš„é‡æ–°æ¸²æŸ“  
æ¥ï¼Œæˆ‘ä»¬é‡å†™ä¸‹
```js
function doubleHeight(element) {
  var currentHeight = element.clientHeight;
  window.requestAnimationFrame(function() {
    element.style.height = (currentHeight * 2) + 'px';
  });
}
elements.forEach(doubleHeight);
```
> è¿™æ ·å­å°±è®©è¯»å’Œå†™åˆ†ç¦»äº†ï¼ŒæŠŠæ‰€æœ‰çš„å†™æ“ä½œéƒ½æ”¾åˆ°ä¸‹ä¸€æ¬¡é‡æ–°æ¸²æŸ“  

é¡µé¢çš„æ»šåŠ¨äº‹ä»¶(scroll)çš„ç›‘å¬å‡½æ•°ï¼Œå°±å¾ˆé€‚åˆ`window.requestAnimationFrame()`ï¼ŒæŽ¨è¿Ÿåˆ°ä¸‹ä¸€æ¬¡é‡æ–°æ¸²æŸ“
```js
$(window).on('scroll', function() {
  window.requestAnimationFrame(scrollHandler);
})
```
å½“ç„¶ï¼Œæœ€é€‚åˆçš„åœºåˆè¿˜æ˜¯ç½‘é¡µåŠ¨ç”»ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªæ—‹è½¬åŠ¨ç”»çš„ä¾‹å­ï¼Œå…ƒç´ æ¯ä¸€å¸§æ—‹è½¬ä¸€åº¦
ä¸çŸ¥é“å’ŒCSSåŠ¨ç”»å“ªä¸ªä¼˜å…ˆ
```js
var rAF = window.requestAnimationFrame;
var degrees = 0;
var div = document.getElementById('div')
var pid = 0
function update() {
  div.style.transform = "rotate("+ degrees +"deg)"
  degrees += 1
  pid = rAF(update);
  if (degrees > 100) {
    window.cancelAnimationFrame(pid) // å–æ¶ˆåŠ¨ç”»
  }
}
rAF(update);
```

## widow.requestIdleCallback()
è¿™ä¹Ÿæ˜¯ä¸€ä¸ªè°ƒèŠ‚é‡æ–°æ¸²æŸ“çš„å‡½æ•°ï¼Œå®ƒæŒ‡å®šåªæœ‰å½“ä¸€å¸§çš„æœ«å°¾æœ‰ç©ºé—²æ—¶é—´ï¼Œæ‰ä¼šæ‰§è¡Œå›žæŽ‰
```js
requestIdleCallback(fn, ms);
```
> åªæœ‰å½“å‰å¸§çš„è¿è¡Œæ—¶é—´å°äºŽ16.66msæ—¶æ‰ä¼šæ‰§è¡Œï¼Œå¦åˆ™å°±æ— é™æŽ¨è¿Ÿï¼Œå¯é€‰å‚æ•°`ms`æ˜¯åœ¨æŒ‡å®šæ—¶é—´å†…å¼ºåˆ¶æ‰§è¡Œ  

å‡½æ•°fnå¯ä»¥æŽ¥å—ä¸€ä¸ªdeadlineå¯¹è±¡ä½œä¸ºå‚æ•°
```js
  requestIdleCallback(function someHeavyComputation(deadline) {
    while(deadline.timeRemaining() > 0) {
      doWorkIfNeeded();
    }

    if(thereIsMoreWorkToDo) {
      requestIdleCallback(someHeavyComputation);
    }
  })
```
> ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå›žè°ƒå‡½æ•°someHeavyComputationçš„å‚æ•°æ˜¯ä¸€ä¸ªdeadlineå¯¹è±¡ã€‚
> deadlineå¯¹è±¡æœ‰ä¸€ä¸ªæ–¹æ³•å’Œä¸€ä¸ªå±žæ€§
> 1. timeRemaining() æ–¹æ³•
> 2. didTimeout å±žæ€§
